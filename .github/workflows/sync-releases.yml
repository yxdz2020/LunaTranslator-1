name: ğŸ”„ Sync Upstream Releases & Assets (Official GH CLI)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

# ----------------------------------------------------
# âš ï¸!! è¯·åœ¨è¿™é‡Œä¿®æ”¹ä¸Šæ¸¸ä»“åº“çš„è·¯å¾„ !!
env:
  UPSTREAM_REPO: 'HIllya51/LunaTranslator'
# ----------------------------------------------------

jobs:
  # --- ä½œä¸š 1: æ£€æŸ¥æœ‰å“ªäº› Releases ç¼ºå¤± ---
  check:
    runs-on: ubuntu-latest
    outputs:
      # âš ï¸ æ›´æ”¹ï¼šä¸å†è¾“å‡ºJSONï¼Œè€Œæ˜¯è¾“å‡ºä¸€ä¸ªå¤šè¡Œå­—ç¬¦ä¸²
      missing_tags: ${{ steps.check_tags.outputs.MISSING_TAGS }}

    steps:
      - name: 1. æ£€æŸ¥ç¼ºå¤±çš„ Release æ ‡ç­¾ (æŒ‰é¡ºåº)
        id: check_tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
        run: |
          echo "Fetching releases from upstream: $UPSTREAM_REPO"
          # âš ï¸ æ›´æ”¹ï¼š--limit 100 ä¿è¯è·å–è¶³å¤Ÿå¤šçš„å†å²è®°å½•
          gh release list --repo $UPSTREAM_REPO --limit 100 --json tagName --jq '.[] | .tagName' > upstream_tags_raw.txt
          
          echo "Fetching releases from own repo: $OWN_REPO"
          gh release list --repo $OWN_REPO --limit 100 --json tagName --jq '.[] | .tagName' > own_tags.txt

          # âš ï¸ æ›´æ”¹ï¼š'sort -V' ä¼šæŒ‰ç‰ˆæœ¬å·æ­£ç¡®æ’åº (ä¾‹å¦‚ v1.10 ä¼šåœ¨ v1.9 ä¹‹å)
          sort -V upstream_tags_raw.txt > upstream_tags.txt

          echo "Comparing tags..."
          # comm ä¼šè¾“å‡ºåªåœ¨ä¸Šæ¸¸ã€ä¸”å·²æ’åºçš„åˆ—è¡¨ (ä»æ—§åˆ°æ–°)
          comm -23 upstream_tags.txt <(sort -V own_tags.txt) > missing_tags.txt

          if [ ! -s missing_tags.txt ]; then
            echo "âœ… Releases are already in sync."
            echo "MISSING_TAGS=''" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”” Found missing tags (oldest to newest):"
            cat missing_tags.txt
            # ä½¿ç”¨Heredocæ ¼å¼å®‰å…¨åœ°è¾“å‡ºå¤šè¡Œå­—ç¬¦ä¸²
            {
              echo 'MISSING_TAGS<<EOF'
              cat missing_tags.txt
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

  # --- ä½œä¸š 2: åŒæ­¥ç¼ºå¤±çš„ Releases ---
  sync:
    needs: check
    # âš ï¸ æ›´æ”¹ï¼šæ£€æŸ¥ 'missing_tags' æ˜¯å¦ä¸ºç©º
    if: needs.check.outputs.missing_tags != ''

    runs-on: ubuntu-latest
    permissions:
      contents: write

    # âš ï¸ å…³é”®æ›´æ”¹ï¼šåˆ é™¤äº† 'strategy: matrix'
    
    steps:
      # âš ï¸ å…³é”®æ›´æ”¹ï¼šç°åœ¨åªæœ‰ä¸€ä¸ª 'step'ï¼Œå®ƒå†…éƒ¨åŒ…å«ä¸€ä¸ªå¾ªç¯
      - name: "2. å¾ªç¯åŒæ­¥ Release (ä»æ—§åˆ°æ–°)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
          # æ¥æ”¶æ¥è‡ª 'check' ä½œä¸šçš„æ•´ä¸ªå¤šè¡Œå­—ç¬¦ä¸²
          TAG_LIST: ${{ needs.check.outputs.missing_tags }}
        run: |
          # é€è¡Œè¯»å– TAG_LISTï¼Œè¿™ä¼šä¿æŒ 'check' ä½œä¸šä¸­æ’åºçš„é¡ºåº
          echo "$TAG_LIST" | while read TAG_TO_SYNC; do
            # å¦‚æœè¯»åˆ°ç©ºè¡Œåˆ™è·³è¿‡
            if [ -z "$TAG_TO_SYNC" ]; then
              continue
            fi

            echo "================================================="
            echo "Syncing release for tag: $TAG_TO_SYNC"
            
            # --- æ­¥éª¤ 2.1: è·å–ä¸Šæ¸¸ Release è¯¦ç»†ä¿¡æ¯ ---
            echo "--- Fetching release metadata from $UPSTREAM_REPO ---"
            gh release view $TAG_TO_SYNC --repo $UPSTREAM_REPO \
              --json name,body,isPrerelease,targetCommitish > release_details.json

            # --- æ­¥éª¤ 2.2: å‡†å¤‡ gh å‘½ä»¤çš„å‚æ•° ---
            TITLE=$(jq -r .name release_details.json)
            NOTES_FILE="notes.txt"
            jq -r .body release_details.json > $NOTES_FILE
            
            # ----------------------------------------------------
            # âš ï¸!! è¿™å°±æ˜¯ä¿®æ­£çš„åœ°æ–¹ (é»‘çº¿) !!
            # vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
            # åˆ é™¤äº† '---'ï¼Œåªä¿ç•™æ¢è¡Œå’Œ "Synced from"
            echo -e "\n\nSynced from https://github.com/$UPSTREAM_REPO" >> $NOTES_FILE
            # ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            # ----------------------------------------------------

            IS_PRERELEASE=$(jq .isPrerelease release_details.json)
            TARGET_SHA=$(jq -r .targetCommitish release_details.json)
            
            EXTRA_ARGS=""
            if [[ "$IS_PRERELEASE" == "true" ]]; then
              EXTRA_ARGS="--prerelease"
            fi

            # --- æ­¥éª¤ 2.3: åœ¨å½“å‰ä»“åº“åˆ›å»º Release (ä»…å…ƒæ•°æ®) ---
            echo "--- Creating release metadata in $OWN_REPO ---"
            gh release create $TAG_TO_SYNC \
              --repo $OWN_REPO \
              --title "$TITLE" \
              --notes-file $NOTES_FILE \
              --target $TARGET_SHA \
              $EXTRA_ARGS

            echo "--- Created metadata for release: $TAG_TO_SYNC"

            # --- æ­¥éª¤ 2.4: ä¸‹è½½ä¸Šæ¸¸ Release çš„æ‰€æœ‰é™„ä»¶ ---
            echo "--- Downloading assets from $UPSTREAM_REPO ---"
            mkdir -p ./temp_assets
            gh release download $TAG_TO_SYNC --repo $UPSTREAM_REPO --dir ./temp_assets

            # --- æ­¥éª¤ 2.5: ä¸Šä¼ é™„ä»¶åˆ°æ–°åˆ›å»ºçš„ Release ---
            if [ -z "$(ls -A ./temp_assets)" ]; then
               echo "No assets found for this release."
            else
               echo "--- Uploading assets to $OWN_REPO ---"
               gh release upload $TAG_TO_SYNC --repo $OWN_REPO --clobber ./temp_assets/*
               echo "âœ… Synced release with assets: $TAG_TO_SYNC"
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•ï¼Œä¸ºä¸‹ä¸€ä¸ªå¾ªç¯åšå‡†å¤‡
            rm -f release_details.json notes.txt
            rm -rf ./temp_assets

          done # å¾ªç¯ç»“æŸ
