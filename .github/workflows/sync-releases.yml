name: ğŸ”„ Sync Upstream Releases & Assets (Official GH CLI)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

# ----------------------------------------------------
# âš ï¸!! è¯·åœ¨è¿™é‡Œä¿®æ”¹ä¸Šæ¸¸ä»“åº“çš„è·¯å¾„ !!
# çœ‹èµ·æ¥ä½ æ¢äº†ä»“åº“ï¼Œè¯·ç¡®ä¿è¿™é‡Œå¡«å†™çš„æ˜¯ subs-check çš„ä¸Šæ¸¸
env:
  UPSTREAM_REPO: 'HIllya51/LunaTranslator'
# ----------------------------------------------------

jobs:
  # --- ä½œä¸š 1: æ£€æŸ¥æœ‰å“ªäº› Releases ç¼ºå¤± ---
  check:
    runs-on: ubuntu-latest
    outputs:
      missing_tags: ${{ steps.check_tags.outputs.MISSING_TAGS }}

    steps:
      - name: 1. æ£€æŸ¥ç¼ºå¤±çš„ Release æ ‡ç­¾ (æŒ‰é¡ºåº)
        id: check_tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
        run: |
          echo "Fetching releases from upstream: $UPSTREAM_REPO"
          # æé«˜ limit ç¡®ä¿èƒ½æŠ“å–æ‰€æœ‰ releases (æ¯”å¦‚ 77 ä¸ª)
          gh release list --repo $UPSTREAM_REPO --limit 100 --json tagName --jq '.[] | .tagName' > upstream_tags_raw.txt
          
          echo "Fetching releases from own repo: $OWN_REPO"
          gh release list --repo $OWN_REPO --limit 100 --json tagName --jq '.[] | .tagName' > own_tags.txt

          # ä½¿ç”¨ 'sort -V' æŒ‰ç‰ˆæœ¬å·æ­£ç¡®æ’åº
          sort -V upstream_tags_raw.txt > upstream_tags.txt

          echo "Comparing tags..."
          # comm ä¼šè¾“å‡ºåªåœ¨ä¸Šæ¸¸ã€ä¸”å·²æ’åºçš„åˆ—è¡¨ (ä»æ—§åˆ°æ–°)
          comm -23 upstream_tags.txt <(sort -V own_tags.txt) > missing_tags.txt

          if [ ! -s missing_tags.txt ]; then
            echo "âœ… Releases are already in sync."
            echo "MISSING_TAGS=''" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”” Found missing tags (oldest to newest):"
            cat missing_tags.txt
            {
              echo 'MISSING_TAGS<<EOF'
              cat missing_tags.txt
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

  # --- ä½œä¸š 2: åŒæ­¥ç¼ºå¤±çš„ Releases (æŒ‰é¡ºåº) ---
  sync:
    needs: check
    if: needs.check.outputs.missing_tags != ''

    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: "2. å¾ªç¯åŒæ­¥ Release (ä»æ—§åˆ°æ–°)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
          TAG_LIST: ${{ needs.check.outputs.missing_tags }}
        run: |
          # é€è¡Œè¯»å– TAG_LISTï¼Œè¿™ä¼šä¿æŒ 'check' ä½œä¸šä¸­æ’åºçš„é¡ºåº
          echo "$TAG_LIST" | while read TAG_TO_SYNC; do
            if [ -z "$TAG_TO_SYNC" ]; then continue; fi

            echo "================================================="
            echo "Syncing release for tag: $TAG_TO_SYNC"
            
            # --- æ­¥éª¤ 2.1: è·å–ä¸Šæ¸¸ Release è¯¦ç»†ä¿¡æ¯ ---
            echo "--- Fetching release metadata from $UPSTREAM_REPO ---"
            gh release view $TAG_TO_SYNC --repo $UPSTREAM_REPO \
              --json name,body,isPrerelease,targetCommitish > release_details.json

            # --- æ­¥éª¤ 2.2: å‡†å¤‡ gh å‘½ä»¤çš„å‚æ•° ---
            TITLE=$(jq -r .name release_details.json)
            NOTES_FILE="notes.txt"
            jq -r .body release_details.json > $NOTES_FILE
            
            # åˆ é™¤äº† '---' é»‘çº¿ï¼Œåªä¿ç•™æ¢è¡Œå’Œ "Synced from"
            echo -e "\n\nSynced from https://github.com/$UPSTREAM_REPO" >> $NOTES_FILE

            IS_PRERELEASE=$(jq .isPrerelease release_details.json)
            TARGET_SHA=$(jq -r .targetCommitish release_details.json)
            
            EXTRA_ARGS=""
            if [[ "$IS_PRERELEASE" == "true" ]]; then
              EXTRA_ARGS="--prerelease"
            fi

            # --- æ­¥éª¤ 2.3: åœ¨å½“å‰ä»“åº“åˆ›å»º Release (ä»…å…ƒæ•°æ®) ---
            echo "--- Creating release metadata in $OWN_REPO ---"
            gh release create $TAG_TO_SYNC \
              --repo $OWN_REPO \
              --title "$TITLE" \
              --notes-file $NOTES_FILE \
              --target $TARGET_SHA \
              $EXTRA_ARGS

            echo "--- Created metadata for release: $TAG_TO_SYNC"

            # --- æ­¥éª¤ 2.4: ä¸‹è½½ä¸Šæ¸¸ Release çš„æ‰€æœ‰é™„ä»¶ ---
            echo "--- Downloading assets from $UPSTREAM_REPO ---"
            mkdir -p ./temp_assets
            gh release download $TAG_TO_SYNC --repo $UPSTREAM_REPO --dir ./temp_assets

            # --- æ­¥éª¤ 2.5: ä¸Šä¼ é™„ä»¶åˆ°æ–°åˆ›å»ºçš„ Release ---
            if [ -z "$(ls -A ./temp_assets)" ]; then
               echo "No assets found for this release."
            else
               echo "--- Uploading assets to $OWN_REPO ---"
               gh release upload $TAG_TO_SYNC --repo $OWN_REPO --clobber ./temp_assets/*
               echo "âœ… Synced release with assets: $TAG_TO_SYNC"
            fi
            
            rm -f release_details.json notes.txt
            rm -rf ./temp_assets
          done # å¾ªç¯ç»“æŸ

  # ----------------------------------------------------
  # âš ï¸!! æ–°å¢çš„ä½œä¸š 3ï¼šä¿®å¤ "Latest" æ ‡ç­¾ !!
  # ----------------------------------------------------
  fix_latest:
    # å¿…é¡»åœ¨ 'sync' ä½œä¸šå®Œæˆåè¿è¡Œ
    needs: sync
    # 'always()' ç¡®ä¿æ— è®º 'sync' æ˜¯å¦è¿è¡Œ (æ¯”å¦‚æ²¡æœ‰ç¼ºå¤±æ ‡ç­¾æ—¶)ï¼Œ
    # 'fix_latest' éƒ½ä¼šè¿è¡Œï¼Œä»¥ç¡®ä¿ "Latest" æ ‡ç­¾å§‹ç»ˆæ­£ç¡®
    if: always() 
    
    runs-on: ubuntu-latest
    permissions:
      contents: write # éœ€è¦å†™å…¥æƒé™æ¥ç¼–è¾‘ Release
      
    steps:
      - name: 3. ä¿®æ­£ "Latest" æ ‡ç­¾
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
        run: |
          echo "Checking upstream for 'Latest' release..."
          # 1. è·å–ä¸Šæ¸¸ä»“åº“ 'Latest' ç‰ˆæœ¬çš„æ ‡ç­¾å (ä¾‹å¦‚ 'v2.1.7')
          # 'gh release list --limit 1' æ€»æ˜¯ä¼šè¿”å›è¢«æ ‡è®°ä¸º 'Latest' çš„é‚£ä¸€ä¸ª
          LATEST_TAG=$(gh release list --repo $UPSTREAM_REPO --limit 1 --json tagName --jq '.[0].tagName')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "Upstream has no 'Latest' release defined. Skipping."
            exit 0
          fi
          
          echo "Upstream 'Latest' tag is: $LATEST_TAG"
          
          # 2. åœ¨æˆ‘ä»¬è‡ªå·±çš„ä»“åº“ï¼Œç¼–è¾‘å¯¹åº”çš„ releaseï¼Œå¼ºåˆ¶å°†å…¶è®¾ä¸º 'Latest'
          echo "Setting '$LATEST_TAG' as 'Latest' on $OWN_REPO"
          gh release edit $LATEST_TAG --repo $OWN_REPO --latest
          
          echo "âœ… 'Latest' tag successfully set to $LATEST_TAG."
