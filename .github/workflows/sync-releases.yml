name: ğŸ”„ Sync Upstream Releases & Assets (Official GH CLI)
# å·¥ä½œæµåç§°ï¼šä½¿ç”¨å®˜æ–¹ GH CLI åŒæ­¥ä¸Šæ¸¸ Releases åŠé™„ä»¶

on:
  # 1. å…è®¸ä½ ä» Actions æ ‡ç­¾é¡µæ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:

  # 2. è®¾ç½®å®šæ—¶ä»»åŠ¡ (æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œä¸€æ¬¡ UTC)
  schedule:
    - cron: '0 3 * * *'

# ----------------------------------------------------
# âš ï¸!! è¯·åœ¨è¿™é‡Œä¿®æ”¹ä¸Šæ¸¸ä»“åº“çš„è·¯å¾„ !!
env:
  UPSTREAM_REPO: 'HIllya51/LunaTranslator'
# ----------------------------------------------------

jobs:
  sync:
    runs-on: ubuntu-latest
    
    # ----------------------------------------------------
    # âš ï¸ å¿…é¡»æ·»åŠ ! 
    # å…è®¸ Action ä½¿ç”¨ GITHUB_TOKEN æ¥è¯»å–å’Œå†™å…¥ 'contents' (ä»£ç , releases, é™„ä»¶)
    permissions:
      contents: write
    # ----------------------------------------------------

    steps:
      - name: 1. æ£€æŸ¥ç¼ºå¤±çš„ Release æ ‡ç­¾
        id: check_tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
        run: |
          echo "Fetching releases from upstream: $UPSTREAM_REPO"
          # è·å–ä¸Šæ¸¸æ‰€æœ‰ release æ ‡ç­¾ (æœ€å¤š100ä¸ª)
          gh release list --repo $UPSTREAM_REPO --limit 100 --json tagName --jq '.[] | .tagName' > upstream_tags.txt
          
          echo "Fetching releases from own repo: $OWN_REPO"
          # è·å–å½“å‰ä»“åº“æ‰€æœ‰ release æ ‡ç­¾ (æœ€å¤š100ä¸ª)
          gh release list --repo $OWN_REPO --limit 100 --json tagName --jq '.[] | .tagName' > own_tags.txt

          echo "Comparing tags..."
          # æ‰¾å‡ºåœ¨ä¸Šæ¸¸ä½†ä¸åœ¨å½“å‰ä»“åº“çš„æ ‡ç­¾
          comm -23 <(sort upstream_tags.txt) <(sort own_tags.txt) > missing_tags.txt

          if [ ! -s missing_tags.txt ]; then
            echo "âœ… Releases are already in sync."
            echo "MISSING_JSON=[]" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”” Found missing tags:"
            cat missing_tags.txt
            # å°†ç¼ºå¤±çš„æ ‡ç­¾åˆ—è¡¨è½¬æ¢æˆä¸€ä¸ª GitHub Actions èƒ½è¯†åˆ«çš„ JSON æ•°ç»„
            MISSING_JSON=$(jq -R -s -c 'split("\n") | map(select(length > 0))' missing_tags.txt)
            echo "MISSING_JSON=$MISSING_JSON" >> $GITHUB_OUTPUT
          fi

      - name: 2. åŒæ­¥ç¼ºå¤±çš„ Release (åŒ…å«é™„ä»¶)
        # ä»…å½“ 'check_tags' æ­¥éª¤æ‰¾åˆ°äº†ç¼ºå¤±æ ‡ç­¾æ—¶æ‰è¿è¡Œ
        if: steps.check_tags.outputs.MISSING_JSON != '[]'
        # ä½¿ç”¨ matrix ç­–ç•¥ï¼Œä¸ºæ¯ä¸ªç¼ºå¤±çš„æ ‡ç­¾å¯åŠ¨ä¸€ä¸ªå¹¶è¡Œçš„æ­¥éª¤
        strategy:
          matrix:
            # fromJson ä¼šè§£æä¸Šä¸€æ­¥è¾“å‡ºçš„ JSON æ•°ç»„ '["tag1","tag2"]'
            tag: ${{ fromJson(steps.check_tags.outputs.MISSING_JSON) }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
        run: |
          echo "Syncing release for tag: ${{ matrix.tag }}"
          
          # --- æ­¥éª¤ 2.1: è·å–ä¸Šæ¸¸ Release è¯¦ç»†ä¿¡æ¯ (æ ‡é¢˜, è¯´æ˜, æ˜¯å¦é¢„å‘å¸ƒ) ---
          echo "--- Fetching release metadata from $UPSTREAM_REPO ---"
          gh release view ${{ matrix.tag }} --repo $UPSTREAM_REPO \
            --json title,body,isPrerelease \
            --template '{{json .}}' > release_details.json

          # --- æ­¥éª¤ 2.2: å‡†å¤‡ gh å‘½ä»¤çš„å‚æ•° ---
          TITLE=$(jq -r .title release_details.json)
          NOTES_FILE="notes.txt"
          jq -r .body release_details.json > $NOTES_FILE
          IS_PRERELEASE=$(jq .isPrerelease release_details.json)
          
          EXTRA_ARGS=""
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            EXTRA_ARGS="--prerelease"
          fi

          # --- æ­¥éª¤ 2.3: åœ¨å½“å‰ä»“åº“åˆ›å»º Release (ä»…å…ƒæ•°æ®) ---
          echo "--- Creating release metadata in $OWN_REPO ---"
          gh release create ${{ matrix.tag }} \
            --repo $OWN_REPO \
            --title "$TITLE" \
            --notes-file $NOTES_FILE \
            $EXTRA_ARGS

          echo "--- Created metadata for release: ${{ matrix.tag }}"

          # --- æ­¥éª¤ 2.4: ä¸‹è½½ä¸Šæ¸¸ Release çš„æ‰€æœ‰é™„ä»¶ ---
          echo "--- Downloading assets from $UPSTREAM_REPO ---"
          # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•æ¥å­˜æ”¾é™„ä»¶
          mkdir -p ./temp_assets
          # ä¸‹è½½è¯¥ tag çš„æ‰€æœ‰é™„ä»¶åˆ°
          gh release download ${{ matrix.tag }} --repo $UPSTREAM_REPO --dir ./temp_assets

          # --- æ­¥éª¤ 2.5: ä¸Šä¼ é™„ä»¶åˆ°æ–°åˆ›å»ºçš„ Release ---
          # æ£€æŸ¥ temp_assets ç›®å½•æ˜¯å¦ä¸ºç©º
          if [ -z "$(ls -A ./temp_assets)" ]; then
             echo "No assets found for this release. Sync complete."
          else
             echo "--- Uploading assets to $OWN_REPO ---"
             # ä½¿ç”¨é€šé…ç¬¦ä¸Šä¼ ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
             # 'clobber' é€‰é¡¹æ„å‘³ç€å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼ˆä¸å¤ªå¯èƒ½ï¼‰ï¼Œåˆ™è¦†ç›–å®ƒ
             gh release upload ${{ matrix.tag }} --repo $OWN_REPO --clobber ./temp_assets/*
             echo "âœ… Synced release with assets: ${{ matrix.tag }}"
          fi
