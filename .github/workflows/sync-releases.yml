name: Sync Upstream Releases

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹æ£€æŸ¥åŒæ­¥ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      upstream_repo:
        description: 'HIllya51/LunaTranslator'
        required: true
        default: 'original/example-repo'

env:
  UPSTREAM_REPO: ${{ github.event.inputs.upstream_repo || 'original/example-repo' }}
  TARGET_REPO: ${{ github.repository }}

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'

      - name: Install GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Get upstream releases
        id: upstream_releases
        run: |
          # è·å–ä¸Šæ¸¸ä»“åº“çš„ releases
          UPSTREAM_RELEASES=$(gh release list --repo $UPSTREAM_REPO --limit 10 --json tagName,isDraft,isPrerelease | jq -r '.[] | select(.isDraft == false) | select(.isPrerelease == false) | .tagName')
          echo "upstream_releases<<EOF" >> $GITHUB_OUTPUT
          echo "$UPSTREAM_RELEASES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get current releases
        id: current_releases
        run: |
          # è·å–å½“å‰ä»“åº“çš„ releases
          CURRENT_RELEASES=$(gh release list --repo $TARGET_REPO --limit 10 --json tagName | jq -r '.[].tagName')
          echo "current_releases<<EOF" >> $GITHUB_OUTPUT
          echo "$CURRENT_RELEASES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find missing releases
        id: missing_releases
        run: |
          # æ¯”è¾ƒå¹¶æ‰¾å‡ºç¼ºå¤±çš„ releases
          UPSTREAM_RELEASES="${{ steps.upstream_releases.outputs.upstream_releases }}"
          CURRENT_RELEASES="${{ steps.current_releases.outputs.current_releases }}"
          
          MISSING_RELEASES=""
          for release in $UPSTREAM_RELEASES; do
            if ! echo "$CURRENT_RELEASES" | grep -q "^$release$"; then
              MISSING_RELEASES="$MISSING_RELEASES $release"
            fi
          done
          
          echo "missing_releases<<EOF" >> $GITHUB_OUTPUT
          echo "$MISSING_RELEASES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Sync missing releases
        if: steps.missing_releases.outputs.missing_releases != ''
        run: |
          MISSING_RELEASES="${{ steps.missing_releases.outputs.missing_releases }}"
          for release in $MISSING_RELEASES; do
            echo "Syncing release: $release"
            
            # ä¸‹è½½ release assets
            gh release download $release --repo $UPSTREAM_REPO --dir ./temp_assets
            
            # åˆ›å»º release notes
            RELEASE_NOTES=$(gh release view $release --repo $UPSTREAM_REPO --json body --jq '.body')
            
            # åˆ›å»ºæ–°çš„ release
            if [ -n "$(ls -A ./temp_assets 2>/dev/null)" ]; then
              gh release create $release \
                --repo $TARGET_REPO \
                --title "$release" \
                --notes "$RELEASE_NOTES" \
                ./temp_assets/*
            else
              gh release create $release \
                --repo $TARGET_REPO \
                --title "$release" \
                --notes "$RELEASE_NOTES"
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf ./temp_assets
          done

      - name: Create summary
        run: |
          MISSING_RELEASES="${{ steps.missing_releases.outputs.missing_releases }}"
          if [ -n "$MISSING_RELEASES" ]; then
            echo "## ğŸ‰ åŒæ­¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "æˆåŠŸåŒæ­¥ä»¥ä¸‹ releasesï¼š" >> $GITHUB_STEP_SUMMARY
            for release in $MISSING_RELEASES; do
              echo "- $release" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "## âœ… æ— éœ€åŒæ­¥" >> $GITHUB_STEP_SUMMARY
            echo "æ‰€æœ‰ releases éƒ½å·²æ˜¯æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          fi
