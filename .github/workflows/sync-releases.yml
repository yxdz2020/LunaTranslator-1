name: Sync Releases with Assets

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  UPSTREAM_REPO: 'HIllya51/LunaTranslator'  # 修改为您需要的仓库

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install requests PyGithub

      - name: Sync releases with Python
        env:
          UPSTREAM_REPO: ${{ env.UPSTREAM_REPO }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'EOF'
          import os
          import requests
          from github import Github
          import tempfile
          import shutil

          # 初始化 GitHub API
          g = Github(os.environ['GITHUB_TOKEN'])
          upstream_repo = os.environ['UPSTREAM_REPO']
          current_repo_name = os.environ['GITHUB_REPOSITORY']
          
          # 获取仓库对象
          upstream = g.get_repo(upstream_repo)
          current_repo = g.get_repo(current_repo_name)
          
          # 获取上游 releases
          upstream_releases = upstream.get_releases()
          
          # 获取当前 releases
          current_releases = current_repo.get_releases()
          current_tags = {release.tag_name for release in current_releases}
          
          # 创建临时目录
          temp_dir = tempfile.mkdtemp()
          
          try:
              synced_count = 0
              
              for release in upstream_releases:
                  if not release.draft and not release.prerelease and release.tag_name not in current_tags:
                      print(f"Syncing release: {release.tag_name}")
                      
                      try:
                          # 创建新 release
                          new_release = current_repo.create_git_release(
                              tag=release.tag_name,
                              name=release.title or release.tag_name,
                              message=release.body or "",
                              draft=False,
                              prerelease=release.prerelease
                          )
                          
                          # 同步附件
                          assets = release.get_assets()
                          if assets.totalCount > 0:
                              print(f"Syncing {assets.totalCount} assets for {release.tag_name}")
                              
                              for asset in assets:
                                  try:
                                      # 下载附件
                                      print(f"Downloading: {asset.name}")
                                      response = requests.get(asset.browser_download_url, headers={
                                          'Authorization': f'token {os.environ["GITHUB_TOKEN"]}'
                                      })
                                      response.raise_for_status()
                                      
                                      # 保存到临时文件
                                      temp_file = os.path.join(temp_dir, asset.name)
                                      with open(temp_file, 'wb') as f:
                                          f.write(response.content)
                                      
                                      # 上传附件
                                      with open(temp_file, 'rb') as f:
                                          new_release.upload_asset(
                                              name=asset.name,
                                              content_type=asset.content_type or 'application/octet-stream',
                                              asset=f
                                          )
                                      
                                      print(f"Uploaded: {asset.name}")
                                      
                                  except Exception as e:
                                      print(f"Failed to sync asset {asset.name}: {e}")
                          
                          print(f"Successfully synced release: {release.tag_name}")
                          synced_count += 1
                          
                      except Exception as e:
                          print(f"Failed to sync release {release.tag_name}: {e}")
              
              print(f"Sync completed. {synced_count} releases synced.")
              
          finally:
              # 清理临时目录
              if os.path.exists(temp_dir):
                  shutil.rmtree(temp_dir)
          EOF
