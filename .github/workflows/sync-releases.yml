name: Sync Releases via API

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: '上游仓库'
        required: true

jobs:
  sync-releases-api:
    runs-on: ubuntu-latest
    steps:
      - name: Sync releases
        uses: actions/github-script@v7
        with:
          script: |
            const { upstream_repo } = process.env;
            const [upstreamOwner, upstreamRepo] = upstream_repo.split('/');
            
            // 获取上游 releases
            const upstreamReleases = await github.rest.repos.listReleases({
              owner: upstreamOwner,
              repo: upstreamRepo,
            });
            
            // 获取当前仓库 releases
            const currentReleases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const currentReleaseTags = new Set(currentReleases.data.map(r => r.tag_name));
            
            // 同步缺失的 releases
            for (const release of upstreamReleases.data) {
              if (!release.draft && !release.prerelease && !currentReleaseTags.has(release.tag_name)) {
                console.log(`Creating release: ${release.tag_name}`);
                
                await github.rest.repos.createRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: release.tag_name,
                  name: release.name || release.tag_name,
                  body: release.body || '',
                  draft: false,
                  prerelease: release.prerelease
                });
              }
            }
        env:
          upstream_repo: ${{ github.event.inputs.upstream_repo }}
