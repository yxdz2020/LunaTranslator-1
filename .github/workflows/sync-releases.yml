name: ğŸ”„ Sync Upstream Releases & Assets (Official GH CLI)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

# ----------------------------------------------------
# âš ï¸!! è¯·åœ¨è¿™é‡Œä¿®æ”¹ä¸Šæ¸¸ä»“åº“çš„è·¯å¾„ !!
env:
  UPSTREAM_REPO: 'HIllya51/LunaTranslator'
# ----------------------------------------------------

jobs:
  # --- ä½œä¸š 1: æ£€æŸ¥æœ‰å“ªäº› Releases ç¼ºå¤± ---
  check:
    runs-on: ubuntu-latest
    outputs:
      missing_json: ${{ steps.check_tags.outputs.MISSING_JSON }}

    steps:
      - name: 1. æ£€æŸ¥ç¼ºå¤±çš„ Release æ ‡ç­¾
        id: check_tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
        run: |
          echo "Fetching releases from upstream: $UPSTREAM_REPO"
          gh release list --repo $UPSTREAM_REPO --limit 100 --json tagName --jq '.[] | .tagName' > upstream_tags.txt
          
          echo "Fetching releases from own repo: $OWN_REPO"
          gh release list --repo $OWN_REPO --limit 100 --json tagName --jq '.[] | .tagName' > own_tags.txt

          echo "Comparing tags..."
          comm -23 <(sort upstream_tags.txt) <(sort own_tags.txt) > missing_tags.txt

          if [ ! -s missing_tags.txt ]; then
            echo "âœ… Releases are already in sync."
            echo "MISSING_JSON=[]" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”” Found missing tags:"
            cat missing_tags.txt
            MISSING_JSON=$(jq -R -s -c 'split("\n") | map(select(length > 0))' missing_tags.txt)
            echo "MISSING_JSON=$MISSING_JSON" >> $GITHUB_OUTPUT
          fi

  # --- ä½œä¸š 2: åŒæ­¥ç¼ºå¤±çš„ Releases ---
  sync:
    needs: check
    if: needs.check.outputs.missing_json != '[]'

    runs-on: ubuntu-latest
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        tag: ${{ fromJson(needs.check.outputs.missing_json) }}

    steps:
      - name: "2. åŒæ­¥ Release (Tag: ${{ matrix.tag }})"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
          TAG_TO_SYNC: ${{ matrix.tag }}
        run: |
          echo "Syncing release for tag: $TAG_TO_SYNC"
          
          # --- æ­¥éª¤ 2.1: è·å–ä¸Šæ¸¸ Release è¯¦ç»†ä¿¡æ¯ ---
          echo "--- Fetching release metadata from $UPSTREAM_REPO ---"
          # ----------------------------------------------------
          # âš ï¸!! è¿™å°±æ˜¯ä¿®æ­£çš„åœ°æ–¹ (title -> name) !!
          # vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
          gh release view $TAG_TO_SYNC --repo $UPSTREAM_REPO \
            --json name,body,isPrerelease \
            --template '{{json .}}' > release_details.json
          # ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
          # ----------------------------------------------------

          # --- æ­¥éª¤ 2.2: å‡†å¤‡ gh å‘½ä»¤çš„å‚æ•° ---
          # ----------------------------------------------------
          # âš ï¸!! è¿™ä¹Ÿæ˜¯ä¿®æ­£çš„åœ°æ–¹ (title -> name) !!
          # vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
          TITLE=$(jq -r .name release_details.json)
          # ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
          # ----------------------------------------------------
          NOTES_FILE="notes.txt"
          jq -r .body release_details.json > $NOTES_FILE
          IS_PRERELEASE=$(jq .isPrerelease release_details.json)
          
          EXTRA_ARGS=""
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            EXTRA_ARGS="--prerelease"
          fi

          # --- æ­¥éª¤ 2.3: åœ¨å½“å‰ä»“åº“åˆ›å»º Release (ä»…å…ƒæ•°æ®) ---
          echo "--- Creating release metadata in $OWN_REPO ---"
          gh release create $TAG_TO_SYNC \
            --repo $OWN_REPO \
            --title "$TITLE" \
            --notes-file $NOTES_FILE \
            $EXTRA_ARGS

          echo "--- Created metadata for release: $TAG_TO_SYNC"

          # --- æ­¥éª¤ 2.4: ä¸‹è½½ä¸Šæ¸¸ Release çš„æ‰€æœ‰é™„ä»¶ ---
          echo "--- Downloading assets from $UPSTREAM_REPO ---"
          mkdir -p ./temp_assets
          gh release download $TAG_TO_SYNC --repo $UPSTREAM_REPO --dir ./temp_assets

          # --- æ­¥éª¤ 2.5: ä¸Šä¼ é™„ä»¶åˆ°æ–°åˆ›å»ºçš„ Release ---
          if [ -z "$(ls -A ./temp_assets)" ]; then
             echo "No assets found for this release. Sync complete."
          else
             echo "--- Uploading assets to $OWN_REPO ---"
             gh release upload $TAG_TO_SYNC --repo $OWN_REPO --clobber ./temp_assets/*
             echo "âœ… Synced release with assets: $TAG_TO_SYNC"
          fi
