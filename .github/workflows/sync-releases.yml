name: ğŸ”„ Sync Upstream Releases & Assets (Official GH CLI)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

# ----------------------------------------------------
# âš ï¸!! è¯·åœ¨è¿™é‡Œä¿®æ”¹ä¸Šæ¸¸ä»“åº“çš„è·¯å¾„ !!
env:
  UPSTREAM_REPO: 'HIllya51/LunaTranslator'
# ----------------------------------------------------

jobs:
  # --- ä½œä¸š 1: æ£€æŸ¥æœ‰å“ªäº› Releases ç¼ºå¤± ---
  check:
    runs-on: ubuntu-latest
    # å®šä¹‰æ­¤ä½œä¸šçš„è¾“å‡º
    outputs:
      # æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåä¸º 'missing_json' çš„è¾“å‡ºï¼Œ
      # å®ƒçš„å€¼æ¥è‡ª 'check_tags' æ­¥éª¤çš„ 'MISSING_JSON' è¾“å‡º
      missing_json: ${{ steps.check_tags.outputs.MISSING_JSON }}

    steps:
      - name: 1. æ£€æŸ¥ç¼ºå¤±çš„ Release æ ‡ç­¾
        id: check_tags # ä¸ºè¿™ä¸ªæ­¥éª¤è®¾ç½®ä¸€ä¸ªIDï¼Œä»¥ä¾¿åœ¨ä¸Šé¢ outputs ä¸­å¼•ç”¨
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
        run: |
          echo "Fetching releases from upstream: $UPSTREAM_REPO"
          gh release list --repo $UPSTREAM_REPO --limit 100 --json tagName --jq '.[] | .tagName' > upstream_tags.txt
          
          echo "Fetching releases from own repo: $OWN_REPO"
          gh release list --repo $OWN_REPO --limit 100 --json tagName --jq '.[] | .tagName' > own_tags.txt

          echo "Comparing tags..."
          comm -23 <(sort upstream_tags.txt) <(sort own_tags.txt) > missing_tags.txt

          if [ ! -s missing_tags.txt ]; then
            echo "âœ… Releases are already in sync."
            # è¾“å‡ºä¸€ä¸ªç©ºçš„JSONæ•°ç»„
            echo "MISSING_JSON=[]" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”” Found missing tags:"
            cat missing_tags.txt
            # å°†ç¼ºå¤±çš„æ ‡ç­¾åˆ—è¡¨è½¬æ¢æˆä¸€ä¸ª GitHub Actions èƒ½è¯†åˆ«çš„ JSON æ•°ç»„
            MISSING_JSON=$(jq -R -s -c 'split("\n") | map(select(length > 0))' missing_tags.txt)
            echo "MISSING_JSON=$MISSING_JSON" >> $GITHUB_OUTPUT
          fi

  # --- ä½œä¸š 2: åŒæ­¥ç¼ºå¤±çš„ Releases ---
  sync:
    # åªæœ‰ "check" ä½œä¸šæˆåŠŸå®Œæˆåæ‰è¿è¡Œ
    needs: check
    # ä»…å½“ "check" ä½œä¸šçš„è¾“å‡º 'missing_json' ä¸æ˜¯ç©ºåˆ—è¡¨ '[]' æ—¶æ‰è¿è¡Œ
    if: needs.check.outputs.missing_json != '[]'

    runs-on: ubuntu-latest
    # æƒé™è®¾ç½®åœ¨ 'sync' ä½œä¸šä¸Š
    permissions:
      contents: write

    # !! å…³é”®æ›´æ­£ï¼š'strategy' ç°åœ¨åœ¨ 'jobs' çº§åˆ«ï¼Œè¿™æ˜¯æ­£ç¡®çš„
    strategy:
      fail-fast: false # å³ä½¿ä¸€ä¸ª tag åŒæ­¥å¤±è´¥äº†ï¼Œä¹Ÿç»§ç»­å°è¯•åŒæ­¥å…¶ä»–çš„
      matrix:
        # ä» "check" ä½œä¸šçš„è¾“å‡ºä¸­åŠ¨æ€è¯»å–æ ‡ç­¾åˆ—è¡¨
        tag: ${{ fromJson(needs.check.outputs.missing_json) }}

    steps:
      - name: 2. åŒæ­¥ Release (Tag: ${{ matrix.tag }})
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
          # ä» matrix ä¸­è·å–å½“å‰è¦åŒæ­¥çš„ tag
          TAG_TO_SYNC: ${{ matrix.tag }}
        run: |
          echo "Syncing release for tag: $TAG_TO_SYNC"
          
          # --- æ­¥éª¤ 2.1: è·å–ä¸Šæ¸¸ Release è¯¦ç»†ä¿¡æ¯ ---
          echo "--- Fetching release metadata from $UPSTREAM_REPO ---"
          gh release view $TAG_TO_SYNC --repo $UPSTREAM_REPO \
            --json title,body,isPrerelease \
            --template '{{json .}}' > release_details.json

          # --- æ­¥éª¤ 2.2: å‡†å¤‡ gh å‘½ä»¤çš„å‚æ•° ---
          TITLE=$(jq -r .title release_details.json)
          NOTES_FILE="notes.txt"
          jq -r .body release_details.json > $NOTES_FILE
          IS_PRERELEASE=$(jq .isPrerelease release_details.json)
          
          EXTRA_ARGS=""
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            EXTRA_ARGS="--prerelease"
          fi

          # --- æ­¥éª¤ 2.3: åœ¨å½“å‰ä»“åº“åˆ›å»º Release (ä»…å…ƒæ•°æ®) ---
          echo "--- Creating release metadata in $OWN_REPO ---"
          gh release create $TAG_TO_SYNC \
            --repo $OWN_REPO \
            --title "$TITLE" \
            --notes-file $NOTES_FILE \
            $EXTRA_ARGS

          echo "--- Created metadata for release: $TAG_TO_SYNC"

          # --- æ­¥éª¤ 2.4: ä¸‹è½½ä¸Šæ¸¸ Release çš„æ‰€æœ‰é™„ä»¶ ---
          echo "--- Downloading assets from $UPSTREAM_REPO ---"
          mkdir -p ./temp_assets
          # ä¸‹è½½è¯¥ tag çš„æ‰€æœ‰é™„ä»¶
          gh release download $TAG_TO_SYNC --repo $UPSTREAM_REPO --dir ./temp_assets

          # --- æ­¥éª¤ 2.5: ä¸Šä¼ é™„ä»¶åˆ°æ–°åˆ›å»ºçš„ Release ---
          if [ -z "$(ls -A ./temp_assets)" ]; then
             echo "No assets found for this release. Sync complete."
          else
             echo "--- Uploading assets to $OWN_REPO ---"
             # ä¸Šä¼ ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
             gh release upload $TAG_TO_SYNC --repo $OWN_REPO --clobber ./temp_assets/*
             echo "âœ… Synced release with assets: $TAG_TO_SYNC"
          fi
