name: Delete All Releases - Fixed

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'è¯·è¾“å…¥ "DELETE ALL RELEASES" æ¥ç¡®è®¤åˆ é™¤æ‰€æœ‰ releases'
        required: true
        type: string
        default: ''

jobs:
  delete-all-releases:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DELETE ALL RELEASES'
    permissions:
      contents: write
    
    steps:
    - name: Install jq
      run: sudo apt update && sudo apt install jq curl -y
    
    - name: Delete all releases
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸš¨ å¼€å§‹åˆ é™¤æ‰€æœ‰ releases..."
        total_deleted=0
        
        # ä¸€æ¬¡æ€§è·å–æ‰€æœ‰ releases
        echo "ğŸ“‹ è·å–æ‰€æœ‰ releases åˆ—è¡¨..."
        response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100")
        
        # æå– releases ä¿¡æ¯åˆ°æ•°ç»„
        mapfile -t releases < <(echo "$response" | jq -r '.[] | "\(.id)|\(.tag_name)"')
        
        if [ ${#releases[@]} -eq 0 ]; then
          echo "â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°ä»»ä½• releases"
          exit 0
        fi
        
        echo "ğŸ—‘ï¸ æ‰¾åˆ° ${#releases[@]} ä¸ª releasesï¼Œå¼€å§‹åˆ é™¤..."
        
        # åˆ é™¤æ¯ä¸ª release
        for release_info in "${releases[@]}"; do
          IFS='|' read -r release_id tag_name <<< "$release_info"
          
          if [ -n "$release_id" ] && [ -n "$tag_name" ]; then
            echo "æ­£åœ¨åˆ é™¤: $tag_name"
            
            delete_code=$(curl -s -w "%{http_code}" -X DELETE \
              -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$release_id" -o /dev/null)
            
            if [ "$delete_code" = "204" ]; then
              echo "âœ… æˆåŠŸåˆ é™¤: $tag_name"
              total_deleted=$((total_deleted + 1))
            else
              echo "âŒ åˆ é™¤å¤±è´¥: $tag_name (HTTP: $delete_code)"
            fi
          fi
        done
        
        echo "ğŸ‰ åˆ é™¤å®Œæˆï¼æ€»å…±åˆ é™¤äº† $total_deleted ä¸ª releases"
