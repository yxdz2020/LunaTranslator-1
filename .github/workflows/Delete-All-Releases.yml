name: Delete All Releases

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'è¯·è¾“å…¥ "DELETE ALL RELEASES" æ¥ç¡®è®¤åˆ é™¤æ‰€æœ‰ releases'
        required: true
        type: string
        default: ''

jobs:
  delete-all-releases:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DELETE ALL RELEASES'
    permissions:
      contents: write
    
    steps:
    - name: Check confirmation
      run: |
        echo "âœ… ç¡®è®¤å­—ç¬¦ä¸²åŒ¹é…ï¼Œå¼€å§‹åˆ é™¤æ‰€æœ‰ releases..."
        echo "âš ï¸  è¿™æ˜¯ä¸€ä¸ªç ´åæ€§æ“ä½œï¼Œæ— æ³•æ’¤é”€ï¼"
    
    - name: Install GitHub CLI
      run: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh -y
    
    - name: Delete all releases
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ç™»å½• GitHub CLI
        echo "$GH_TOKEN" | gh auth login --with-token
        
        # è·å–æ‰€æœ‰ releases
        echo "ğŸ“‹ è·å– releases åˆ—è¡¨..."
        releases=$(gh release list --repo ${{ github.repository }} --limit 200 -q '.[]' || true)
        
        if [ -z "$releases" ]; then
          echo "â„¹ï¸  æ²¡æœ‰æ‰¾åˆ°ä»»ä½• releases"
          exit 0
        fi
        
        # æ˜¾ç¤ºæ‰¾åˆ°çš„ releases
        echo "ğŸ—‘ï¸  å³å°†åˆ é™¤ä»¥ä¸‹ releases:"
        echo "$releases"
        echo ""
        
        # åˆ é™¤æ¯ä¸ª release
        while read -r line; do
          if [ -n "$line" ]; then
            tag_name=$(echo "$line" | awk '{print $1}')
            echo "ğŸš¨ æ­£åœ¨åˆ é™¤: $tag_name"
            gh release delete "$tag_name" --repo ${{ github.repository }} --yes || echo "âš ï¸  åˆ é™¤ $tag_name å¤±è´¥"
          fi
        done <<< "$releases"
        
        echo ""
        echo "âœ… æ‰€æœ‰ releases åˆ é™¤å®Œæˆï¼"
