name: Delete All Releases - API Only

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'è¯·è¾“å…¥ "DELETE ALL RELEASES" æ¥ç¡®è®¤åˆ é™¤æ‰€æœ‰ releases'
        required: true
        type: string
        default: ''

jobs:
  delete-all-releases:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DELETE ALL RELEASES'
    permissions:
      contents: write
    
    steps:
    - name: Check confirmation
      run: |
        echo "âœ… ç¡®è®¤å­—ç¬¦ä¸²åŒ¹é…ï¼Œå¼€å§‹åˆ é™¤æ‰€æœ‰ releases..."
        echo "âš ï¸  è¿™æ˜¯ä¸€ä¸ªç ´åæ€§æ“ä½œï¼Œæ— æ³•æ’¤é”€ï¼"
    
    - name: Install jq
      run: sudo apt update && sudo apt install jq curl -y
    
    - name: Delete all releases via API
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸš¨ å¼€å§‹åˆ é™¤æ‰€æœ‰ releases..."
        
        page=1
        total_deleted=0
        
        while true; do
          echo "ğŸ“„ è·å–ç¬¬ $page é¡µ releases..."
          
          # è·å– releases åˆ—è¡¨
          response=$(curl -s -w "%{http_code}" -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases?page=$page&per_page=100")
          
          http_code=$(echo "$response" | tail -n1)
          json_response=$(echo "$response" | head -n -1)
          
          # æ£€æŸ¥å“åº”
          if [ "$http_code" != "200" ]; then
            echo "âŒ API è¯·æ±‚å¤±è´¥ï¼ŒHTTP ä»£ç : $http_code"
            echo "å“åº”: $json_response"
            break
          fi
          
          # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ•°æ®
          count=$(echo "$json_response" | jq length)
          if [ "$count" -eq 0 ]; then
            echo "âœ… æ‰€æœ‰ releases å·²å¤„ç†å®Œæˆ"
            break
          fi
          
          echo "ğŸ“‹ æ‰¾åˆ° $count ä¸ª releases"
          
          # å¤„ç†å½“å‰é¡µçš„ releases
          echo "$json_response" | jq -r '.[] | "\(.id)|\(.tag_name)"' | while IFS='|' read -r release_id tag_name; do
            if [ -n "$release_id" ] && [ -n "$tag_name" ]; then
              echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤: $tag_name (ID: $release_id)"
              
              # åˆ é™¤ release
              delete_response=$(curl -s -w "%{http_code}" -X DELETE \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/releases/$release_id")
              
              delete_http_code=$(echo "$delete_response" | tail -n1)
              
              if [ "$delete_http_code" = "204" ]; then
                echo "âœ… æˆåŠŸåˆ é™¤: $tag_name"
                total_deleted=$((total_deleted + 1))
              else
                echo "âŒ åˆ é™¤å¤±è´¥: $tag_name (HTTP: $delete_http_code)"
              fi
            fi
          done
          
          ((page++))
          sleep 1  # é¿å… API é€Ÿç‡é™åˆ¶
        done
        
        echo "ğŸ‰ åˆ é™¤å®Œæˆï¼æ€»å…±åˆ é™¤äº† $total_deleted ä¸ª releases"
